<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Firebase-Tutorial</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="css/materialize.min.css"  media="screen,projection"/>
    <link rel="stylesheet" href="css/custom.css">
  </head>
  <body>
    <!-- 로그인 화면 및 가입화면 영역 -->
    <div id="dvAuth">
      <div id="dvLogin">
          <h5>로그인</h5>
          <div id="dvSocial">
              <ul class="btnGroup">
                  <li id="liGoogleBtn" class="waves-effect waves-teal btn-flat"><i></i>구글 계정으로 가입 및 로그인</li>
                  <li id="liFacebookBtn" class="waves-effect waves-teal btn-flat"><i></i>페이스북 계정으로 가입 및 로그인</li>
                  <li id="liTwitterBtn" class="waves-effect waves-teal btn-flat"><i></i>트위터 계정으로 가입 및 로그인</li>
                  <li id="liGithubBtn" class="waves-effect waves-teal btn-flat"><i></i>깃헙 계정으로 가입 및 로그인</li>
                  <li id="liPhoneBtnShow" class="waves-effect waves-teal btn-flat"><a class="modal-trigger" href="#dvPhoneModal"><i></i>폰번호로 가입 및 로그인</a></li>
                  <li id="liLogOut" class="waves-effect waves-teal btn-flat">로그아웃</li>
              </ul>
              <em class="or">or</em>
          </div>
          <div id="dvEmail">
              <input type="email" id="userName" name="userName" class="input-text" placeholder="이메일 아이디">
              <input type="password" id="password" name="password" class="input-text" maxlength="17" placeholder="비밀번호">
              <ul class="btnGroup">
                  <li id="liEmailBtn" class="waves-effect waves-teal btn-flat">이메일으로 로그인</li>
              </ul>
              <ul class="btnGroup">
                  <li id="liEmailJoin" class="waves-effect waves-teal btn-flat">이메일으로 가입</li>
              </ul>
          </div>
      </div>
      <div id="dvJoin">
          <h5>이메일 가입</h5>
          <input type="text" id="joinUserName" name="userName" class="input-text" placeholder="이름">
          <input type="email" id="joinUserEmail" name="userName" class="input-text" placeholder="이메일 아이디">
          <input type="password" id="joinPassword" name="password" class="input-text" maxlength="17" placeholder="비밀번호">
          <input type="password" id="joinRePassword" class="input-text" maxlength="17" placeholder="비밀번호 확인">
          <ul class="btnGroup">
              <li id="liEmailJoinSubmit" class="waves-effect waves-teal btn-flat">이메일으로 가입</li>
          </ul>
      </div>
    </div>
    <div id="dvPhoneModal" class="modal">
        <div class="modal-content">
            <h4>전화번호 입력</h4>
            <div>
                <input type="tel" id="phoneNumber" name="phoneNumber" class="input-text" placeholder="전화번호">
                <a href="#!" id='aPhoneSend' class="waves-effect waves-green btn-flat">전송</a>
                <div id="recaptcha"></div>
            </div>
            <input type="tel" id="authCode" name="authCode" class="input-text" placeholder="인증번호">
        </div>
        <div class="modal-footer">
            <a href="#!" id='aPhoneBtn' class="waves-effect waves-green btn-flat">로그인</a>
        </div>
    </div>
      <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
      <script type="text/javascript" src="js/materialize.min.js"></script>
      <!-- update the version number as needed -->
      <script src="https://www.gstatic.com/firebasejs/4.6.1/firebase-app.js"></script>
      <script src="https://www.gstatic.com/firebasejs/4.6.1/firebase-auth.js"></script>
      <script>
          // Firebase console 화면에서 가져온 코드
          var config = {
              apiKey: "AIzaSyDj2zZF7mA8C2Vr-HG61XQ5RzUEE9sxAAg",
              authDomain: "fir-authentication-kr.firebaseapp.com",
              databaseURL: "https://fir-authentication-kr.firebaseio.com",
              projectId: "fir-authentication-kr",
              storageBucket: "fir-authentication-kr.appspot.com",
              messagingSenderId: "654453477928"
          };
          firebase.initializeApp(config);

          //구글 로그인 버튼 누를 시
          document.getElementById('liGoogleBtn').addEventListener('click',function(){

              var googleProvider = new firebase.auth.GoogleAuthProvider();
              firebase.auth().setPersistence(firebase.auth.Auth.Persistence.NONE)
                  .then(function() {
                      return  firebase.auth().signInWithPopup(googleProvider).then(function(result) {
                          var user = result.user;
                          console.log('user : ', user);
                      }).catch(function(error) {
                          console.error('',error);
                      });
                  })
                  .catch(function(error) {
                      var errorCode = error.code;
                      var errorMessage = error.message;
                  });


          });

          //페이스북 로그인 버튼 누를 시
          document.getElementById('liFacebookBtn').addEventListener('click',function(){

              var facebookProvider = new firebase.auth.FacebookAuthProvider();
              firebase.auth().setPersistence(firebase.auth.Auth.Persistence.NONE)
                  .then(function() {
                      return  firebase.auth().signInWithPopup(facebookProvider).then(function(result) {
                          var user = result.user;
                          console.log('user : ', user);
                      }).catch(function(error) {
                          console.error('',error);
                      });
                  })
                  .catch(function(error) {
                      var errorCode = error.code;
                      var errorMessage = error.message;
                  });


          });

          //트위터 로그인 버튼 누를 시
          document.getElementById('liTwitterBtn').addEventListener('click',function(){

              var twitterProvider = new firebase.auth.TwitterAuthProvider();
              firebase.auth().setPersistence(firebase.auth.Auth.Persistence.NONE)
                  .then(function() {
                      return  firebase.auth().signInWithPopup(twitterProvider).then(function(result) {
                          var user = result.user;
                          console.log('user : ', user);
                      }).catch(function(error) {
                          console.error('',error);
                      });
                  })
                  .catch(function(error) {
                      var errorCode = error.code;
                      var errorMessage = error.message;
                  });
          });

          //깃헙 로그인 버튼 누를 시
          document.getElementById('liGithubBtn').addEventListener('click',function(){
              var githubProvider = new firebase.auth.GithubAuthProvider();
              firebase.auth().setPersistence(firebase.auth.Auth.Persistence.NONE)
                  .then(function() {
                      return  firebase.auth().signInWithPopup(githubProvider).then(function(result) {
                          var user = result.user;
                          console.log('user : ', user);
                      }).catch(function(error) {
                          console.error('',error);
                      });
                  })
                  .catch(function(error) {
                      var errorCode = error.code;
                      var errorMessage = error.message;
                  });
          });

          //로그아웃
          document.getElementById('liLogOut').addEventListener('click',function(){
              if(confirm('로그아웃 하시겠습니까?')){
                  firebase.auth().signOut();
              }
          });

          //reCAPTCHA 인증기 설정
          window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha', {
              'size': 'invisible'
          });

          //폰인증 폰번호 전송 버튼
          document.getElementById('aPhoneSend').addEventListener('click', function(){
              var phoneNumber = '+82'+document.getElementById('phoneNumber').value.trim().substring(1);
              var appVerifier = window.recaptchaVerifier;
              firebase.auth().setPersistence(firebase.auth.Auth.Persistence.NONE)
                  .then(function() {
                      return  firebase.auth().signInWithPhoneNumber(phoneNumber, appVerifier)
                          .then(function (confirmationResult) {
                              alert('인증번호를 확인해주십시오');
                              window.confirmationResult = confirmationResult;
                              console.log('confirmationResult : ', confirmationResult);
                          }).catch(function (error) {
                              console.error('error : ', error);
                          });
                  })
                  .catch(function(error) {
                      var errorCode = error.code;
                      var errorMessage = error.message;
                  });

          });

          //폰번호 가입 및 로그인
          document.getElementById('aPhoneBtn').addEventListener('click',function(){
              var authCode = document.getElementById('authCode').value;
              confirmationResult.confirm(authCode).then(function (result) {
                  $('#dvPhoneModal').modal('close');
              }).catch(function (error) {
                  console.error('error : ', error);
              });
          });

          //이메일 가입 폼 보이기
          document.getElementById('liEmailJoin').addEventListener('click', function(){
              document.getElementById('dvLogin').style.display='none';
              document.getElementById('dvJoin').style.display='block';
          });

          //유효성 검증 후 이메일 가입 처리
          document.getElementById('liEmailJoinSubmit').addEventListener('click', function(){
              var userName = document.getElementById('joinUserName').value.trim();
              var email = document.getElementById('joinUserEmail').value.trim();
              var password = document.getElementById('joinPassword').value.trim();
              var rePassword =document.getElementById('joinRePassword').value.trim();
              // 유효성 검증
              if(validateJoinForm(email, password, rePassword)){
                  var cbCreateUserWithEmail = function(user){
                      console.log('이메일 가입 성공 : ', user);
                      //프로필 업데이트 - 이메일 가입시 유저이름 파라미터를 보내지 않으므로 가입 성공 후 처리
                      user.updateProfile({
                          displayName: userName,
                      }).then(function() {
                          console.log('userName 업데이트 성공')
                      }).catch(function(error) {
                          console.error('userName 업데이트 실패 : ', error );
                      });

                      //인증 메일 발송
                      firebase.auth().useDeviceLanguage(); // 이메일 기기언어로 세팅
                      user.sendEmailVerification().then(function() {
                          console.log('인증메일 발송 성공')
                      }).catch(function(error) {
                          console.error('인증메일 발송 에러', error);
                      });

                      //화면 변경
                      document.getElementById('dvLogin').style.display='block';
                      document.getElementById('dvJoin').style.display='none';

                  }
                  var cbAfterPersistence = function(){
                      return firebase.auth().createUserWithEmailAndPassword(email, password)
                          .then(cbCreateUserWithEmail.bind(this))
                          .catch(function(error) {
                              console.error('이메일 가입시 에러 : ', error);
                              switch(error.code){
                                  case "auth/email-already-in-use":
                                      alert('이미 사용중인 이메일 입니다.');
                                      break;
                                  case "auth/invalid-email":
                                      alert('유효하지 않은 메일입니다');
                                      break;
                                  case "auth/operation-not-allowed":
                                      alert('이메일 가입이 중지되었습니다.');
                                      break;
                                  case "auth/weak-password":
                                      alert("비밀번호를 6자리 이상 필요합니다");
                                      break;

                              }
                          });
                  }

                  firebase.auth().setPersistence(firebase.auth.Auth.Persistence.NONE)
                      .then(cbAfterPersistence.bind(this))
                      .catch(function(error) {
                          console.error('인증 상태 설정 중 에러 발생' , error);
                      });


              }
          });


          //이메일 가입 폼에서 유효성 체크
          var validateJoinForm = function(email, password, rePassword){
              //이메일 유효성 체크
              if(!emailCheck(email)){
                  alert("이메일 형식에 맞지 않습니다");
                  return false;
              }
              //패스워드 동일 여부 체크
              if(password !== rePassword){
                  alert('패스워드가 동일하지 않습니다');
                  return false
              }

              return true;
          }

          //이메일 형식 체크
          var emailCheck = function(mail){
              if (/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(mail)) {
                  return true;
              }
              return false;
          }

          //이메일 로그인
          document.getElementById('liEmailBtn').addEventListener('click', function () {
              var email = document.getElementById('userName').value.trim();
              var password = document.getElementById('password').value.trim();
              if(emailCheck(email) && password.length > 0){ // 유효성 체크
                  var cbSignInEmail = function() {
                      return  firebase.auth().signInWithEmailAndPassword(email, password)
                          .then(function(){
                              console.log('이메일 로그인 성공');
                          })
                          .catch(function(error) {
                              console.error('이메일 로그인 과정 에러', error);
                              switch(error.code){
                                  case "auth/invalid-email":
                                      alert('유효하지 않은 메일입니다');
                                      break;
                                  case "auth/user-disabled":
                                      alert('사용이 정지된 유저 입니다.')
                                      break;
                                  case "auth/user-not-found":
                                      alert('사용자를 찾을 수 없습니다.')
                                      break;
                                  case "auth/wrong-password":
                                      alert("잘못된 패스워드 입니다.");
                                      break;

                              }
                          });
                  }
                  firebase.auth().setPersistence(firebase.auth.Auth.Persistence.NONE)
                      .then(cbSignInEmail.bind(this));
              }
          });



          // 인증 상태 변화 관찰
          firebase.auth().onAuthStateChanged(function(user) {
              if (user) {
                  alert('로그인 되었습니다.');
                  document.getElementById('dvLogin').style.display='block';
                  document.getElementById('dvJoin').style.display='none';
              } else {
                  alert('로그아웃 되었습니다.');
              }
          });

          $(function(){
              $('#dvPhoneModal').modal();
          });

      </script>
  </body>
</html>
